generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PromotionType {
  PRODUCT_DISCOUNT // Discount on products
  FREE_SHIPPING // Free shipping promotion
  BOGO // Buy One Get One
  BUNDLE // Bundle discount
  CART_DISCOUNT // Cart-level discount
}

enum CollectionType {
  MANUAL // Manually curated products
  AUTOMATIC // Auto-populated based on rules
  SEASONAL // Seasonal collections (Summer, Winter, etc.)
  DEAL // Deal/discount collections (Black Friday, Flash Sale)
  NEW_ARRIVAL // New arrivals
  BESTSELLER // Best selling products
}

enum InventoryLogType {
  ORDER_PLACED // Stock decreased via an order
  ORDER_CANCELLED // Stock returned due to cancellation
  MANUAL_ADJUSTMENT // Admin manually adjusted inventory
  RESTOCK // New inventory added to warehouse
  DAMAGED_LOST // Lost/damaged items removed from inventory
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  role          UserRole  @default(CUSTOMER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  addresses     Address[]
  orders        Order[]
  cartItems     CartItem[]
  reviews       Review[]
  wishlists     Wishlist[]
  inventoryLogs InventoryLog[]

  @@unique([email])
  @@index([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Address {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName     String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  zipCode      String
  country      String  @default("US")
  isDefault    Boolean @default(false)

  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Category {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String?
  isActive    Boolean @default(true)
  order       Int     @default(0)

  parentId String?
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children Category[] @relation("CategoryToCategory")

  metaTitle       String?
  metaDescription String?

  products Product[]

  promotions PromotionCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([parentId])
}

model Brand {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  logo        String?
  isActive    Boolean @default(true)

  products Product[]

  promotions PromotionBrand[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model Product {
  id          String @id @default(cuid())
  name        String
  slug        String @unique
  description String @db.Text

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id])

  basePrice  Decimal       @db.Decimal(10, 2)
  isActive   Boolean       @default(true)
  isFeatured Boolean       @default(false)
  status     ProductStatus @default(DRAFT)
  tags       String[]

  metaTitle       String?
  metaDescription String?

  variants       ProductVariant[]
  images         ProductImage[]
  reviews        Review[]
  wishlists      Wishlist[]
  collections    CollectionProduct[]
  promotions     PromotionProduct[]
  productOptions ProductOption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([brandId])
  @@index([isFeatured])
  @@index([status])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku            String   @unique
  stock          Int      @default(0)
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)

  image          String?
  variantOptions VariantOption[]

  orderItems OrderItem[]
  cartItems  CartItem[]

  inventoryLogs InventoryLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sku])
  @@index([productId])
}

model ProductOption {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name   String // "Size", "Color", etc.
  values String[] // ["S", "M", "L"], ["Red", "Black"], etc.

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  variantOptions VariantOption[]

  @@index([productId])
}

model VariantOption {
  id String @id @default(cuid())

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  optionId String
  option   ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  value String // must be one of option.values[]

  createdAt DateTime @default(now())

  @@unique([variantId, optionId])
  @@index([value])
  @@index([variantId])
  @@index([optionId])
}

model InventoryLog {
  id        String         @id @default(cuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  change         Int
  resultingStock Int
  type           InventoryLogType

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  adminId String?
  admin   User?   @relation(fields: [adminId], references: [id], onDelete: SetNull)

  note String?

  createdAt DateTime @default(now())

  @@index([variantId])
  @@index([type])
  @@index([createdAt])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url     String
  altText String?
  order   Int     @default(0)

  createdAt DateTime @default(now())

  @@index([productId])
}

model Collection {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  image       String?

  type CollectionType @default(MANUAL)

  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)
  order      Int     @default(0)

  // Automatic collection rules (JSON stored as string)
  // Example: {"conditions": [{"field": "tags", "operator": "contains", "value": "summer"}]}
  rules String? @db.Text

  metaTitle       String?
  metaDescription String?

  publishedAt DateTime?
  validFrom   DateTime?
  validUntil  DateTime?

  products   CollectionProduct[]
  coupons    CollectionCoupon[]
  promotions PromotionCollection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([type])
  @@index([isActive])
  @@index([isFeatured])
}

model CollectionProduct {
  id           String     @id @default(cuid())
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  order   Int      @default(0)
  addedAt DateTime @default(now())

  @@unique([collectionId, productId])
  @@index([collectionId])
  @@index([productId])
}

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique
  userId      String
  user        User   @relation(fields: [userId], references: [id])

  status   OrderStatus @default(PENDING)
  subtotal Decimal     @db.Decimal(10, 2)
  tax      Decimal     @db.Decimal(10, 2)
  shipping Decimal     @db.Decimal(10, 2)
  discount Decimal     @default(0) @db.Decimal(10, 2)
  total    Decimal     @db.Decimal(10, 2)

  shippingAddressId String
  shippingAddress   Address @relation(fields: [shippingAddressId], references: [id])

  paymentIntentId String?
  trackingNumber  String?
  notes           String? @db.Text

  items   OrderItem[]
  reviews Review[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  inventoryLogs InventoryLog[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  quantity Int
  price    Decimal @db.Decimal(10, 2)
  subtotal Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productVariantId])
}

model CartItem {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  quantity Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productVariantId])
  @@index([userId])
}

model Review {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  rating     Int
  title      String?
  comment    String? @db.Text
  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
}

model Wishlist {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
}

model Coupon {
  id          String       @id @default(cuid())
  code        String       @unique
  type        DiscountType
  value       Decimal      @db.Decimal(10, 2)
  minPurchase Decimal?     @db.Decimal(10, 2)
  maxDiscount Decimal?     @db.Decimal(10, 2)
  usageLimit  Int?
  usageCount  Int          @default(0)
  validFrom   DateTime
  validUntil  DateTime
  isActive    Boolean      @default(true)

  collections CollectionCoupon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

model Promotion {
  id   String        @id @default(cuid())
  name String
  code String?       @unique
  type PromotionType

  discountType  DiscountType?
  discountValue Decimal?      @db.Decimal(10, 2)

  minPurchase Decimal? @db.Decimal(10, 2)
  minQuantity Int?
  maxDiscount Decimal? @db.Decimal(10, 2)

  // Buy one Get One configuration (stored as JSON)
  // Example: {"buy": 2, "get": 1, "discountPercent": 100}
  bogoConfig String? @db.Text

  usageLimit       Int?
  usagePerCustomer Int?
  usageCount       Int  @default(0)

  validFrom  DateTime
  validUntil DateTime
  isActive   Boolean  @default(true)

  applyToAllProducts Boolean @default(false)
  excludeSaleItems   Boolean @default(false)

  applicableCategories  PromotionCategory[]
  applicableBrands      PromotionBrand[]
  applicableProducts    PromotionProduct[]
  applicableCollections PromotionCollection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([type])
  @@index([isActive])
}

model PromotionCategory {
  id          String    @id @default(cuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([promotionId, categoryId])
  @@index([promotionId])
  @@index([categoryId])
}

model PromotionBrand {
  id          String    @id @default(cuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([promotionId, brandId])
  @@index([promotionId])
  @@index([brandId])
}

model PromotionProduct {
  id          String    @id @default(cuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([promotionId, productId])
  @@index([promotionId])
  @@index([productId])
}

model PromotionCollection {
  id          String    @id @default(cuid())
  promotionId String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([promotionId, collectionId])
  @@index([promotionId])
  @@index([collectionId])
}

model CollectionCoupon {
  id           String     @id @default(cuid())
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  couponId String
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([collectionId, couponId])
  @@index([collectionId])
  @@index([couponId])
}
